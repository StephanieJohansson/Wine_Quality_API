<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wine Quality API</title>
  <link rel="stylesheet" href="/static/style.css">

  <!-- Flask template links for static files -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>

<body>
  <header class="header">
    <h1>üç∑ Wine Quality</h1>
    <p class="muted">
      Predict wine quality class (<span class="pill">low</span><span class="pill">medium</span><span class="pill">high</span>) using a trained Random Forest model.
    </p>
  </header>

  <!-- Authentication bar: shows login/logout and current status -->
  <section class="card" id="authBar" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
    <div>
      <span id="authStatus" class="badge-outline">Not logged in</span>
    </div>
    <div class="row" style="display:flex; gap:8px;">
      <button type="button" id="btnLogin">Log in</button>
      <button type="button" id="btnLogout" class="secondary" style="display:none;">Log out</button>
    </div>
  </section>

  <!-- Admin Panel: only visible for admin users (controlled by JS) -->
  <section class="card admin-panel" id="adminPanel" style="display:none;">
    <h2>Admin Panel</h2>
    <p class="hint">Visible only when logged in as admin.</p>
    <div class="row">
      <!-- Each button triggers an admin API endpoint via JS -->
      <button type="button" id="btnAdminInfo">/admin/model-info</button>
      <button type="button" id="btnReload">/admin/reload-model</button>
      <button type="button" id="btnBatch">/admin/predict-batch</button>
      <button type="button" id="btnFI">/admin/feature-importance</button>
      <button type="button" id="btnLogs">/admin/logs</button>
      <button type="button" id="btnClearLogs">clear logs</button>
    </div>
    <div style="margin-top:10px;">
      <!-- Output area for admin API responses -->
      <pre id="adminOutput">No admin requests yet.</pre>
    </div>
  </section>

  <div class="layout">
    <!-- Main content: prediction form and API links -->
    <main>
      <section class="card">
        <h2>Try a prediction</h2>
        <form id="predictForm">
          <div class="grid">
            <!-- Input fields for wine features; some have sliders for better UX -->
            <div><label>fixed acidity</label><input name="fixed acidity" type="number" step="0.01" value="7.2"></div>
            <div>
              <label>volatile acidity</label>
              <div class="range">
                <input id="va_range" type="range" min="0.0" max="1.5" step="0.01" value="0.23">
                <input id="va_input" name="volatile acidity" type="number" step="0.01" value="0.23">
              </div>
              <div class="hint">Higher value ‚Üí more volatile acid (often lower quality).</div>
            </div>
            <div><label>citric acid</label><input name="citric acid" type="number" step="0.01" value="0.32"></div>
            <div><label>residual sugar</label><input name="residual sugar" type="number" step="0.01" value="8.5"></div>
            <div><label>chlorides</label><input name="chlorides" type="number" step="0.001" value="0.058"></div>
            <div><label>free sulfur dioxide</label><input name="free sulfur dioxide" type="number" step="1" value="47"></div>
            <div><label>total sulfur dioxide</label><input name="total sulfur dioxide" type="number" step="1" value="186"></div>
            <div><label>density</label><input name="density" type="number" step="0.0001" value="0.9956"></div>
            <div><label>pH</label><input name="pH" type="number" step="0.01" value="3.19"></div>
            <div><label>sulphates</label><input name="sulphates" type="number" step="0.01" value="0.40"></div>
            <div>
              <label>alcohol</label>
              <div class="range">
                <input id="alc_range" type="range" min="7.0" max="15.0" step="0.1" value="9.9">
                <input id="alc_input" name="alcohol" type="number" step="0.1" value="9.9">
              </div>
              <div class="hint">Higher alcohol ‚Üí often higher quality.</div>
            </div>
            <div>
              <label>type</label>
              <select name="type">
                <option value="white" selected>white</option>
                <option value="red">red</option>
              </select>
            </div>
          </div>
          <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
            <button type="submit">Predict</button>
            <!-- Buttons to load preset values for white/red wine -->
            <button class="secondary" type="button" id="loadWhite">Load white wine example</button>
            <button class="secondary" type="button" id="loadRed">Load red wine example</button>
          </div>
        </form>
        <!-- Prediction result area, shown after submit -->
        <div id="result" style="margin-top:12px; display:none">
          <h3>Result</h3>
          <div id="resultBox"></div>
        </div>
      </section>
      <section class="card">
        <h2>API links</h2>
        <p><a href="/health" target="_blank">/health</a> ¬∑ <a href="/model-info" target="_blank">/model-info</a></p>
      </section>
    </main>

    <!-- Aside: wine lexicon and tips for users -->
    <aside class="aside">
      <section class="card">
        <h3>üìö Wine lexicon (dataset)</h3>
        <p class="hint">Short descriptions + how they tend to affect model predictions.</p>
        <div class="divider"></div>
        <dl class="kv">
          <!-- Each <dt>/<dd> describes a wine feature and its effect -->
          <dt>volatile acidity</dt>
          <dd>Volatile acid (e.g. acetic acid). <em>Higher</em> levels ‚ÜòÔ∏è quality.</dd>
          <dt>alcohol</dt>
          <dd>Alcohol content (%). <em>Higher</em> levels ‚ÜóÔ∏è quality (up to a point).</dd>
          <dt>density</dt>
          <dd>Liquid density. Often <em>lower</em> with higher alcohol ‚Üí correlates with quality.</dd>
          <dt>sulphates</dt>
          <dd>Sulphur compounds that can stabilize and improve structure. <em>Higher</em> ‚ÜóÔ∏è quality (moderately).</dd>
          <dt>citric acid</dt>
          <dd>Adds freshness/acidity. Slight positive effect in some wines.</dd>
          <dt>residual sugar</dt>
          <dd>Remaining sugar. Effect depends on wine type; high sugar ‚â† always high quality.</dd>
          <dt>chlorides</dt>
          <dd>Salt content. <em>Higher</em> can ‚ÜòÔ∏è quality.</dd>
          <dt>free/total sulfur dioxide</dt>
          <dd>Preservation/oxidation protection. Too much can cause off-flavors.</dd>
          <dt>pH</dt>
          <dd>Acidity/basicity (lower = more acidic). Impact is more complex; not as strong a link as alcohol/volatile acidity.</dd>
          <dt>type</dt>
          <dd><code>white</code> or <code>red</code>. The model has learned patterns that differ slightly between types.</dd>
        </dl>
      </section>
      <section class="card">
        <h3>üí° Tips</h3>
        <ul class="hint">
          <li>Increase <strong>alcohol</strong> slider ‚Üí often higher class.</li>
          <li>Increase <strong>volatile acidity</strong> slider ‚Üí often lower class.</li>
          <li>Change <strong>type</strong> to see differences between red/white.</li>
        </ul>
      </section>
    </aside>
  </div>

  <!-- Login Modal: shown when user clicks "Log in" -->
  <div class="modal-backdrop" id="loginModal">
    <div class="modal">
      <h3>Log in</h3>
      <div style="display:grid; gap:8px;">
        <input id="loginUser" placeholder="Username" value="admin" />
        <input id="loginPass" placeholder="Password" type="password" value="admin123" />
      </div>
      <div class="modal-actions">
        <button type="button" id="doLogin">Submit</button>
        <button type="button" id="cancelLogin" class="secondary">Cancel</button>
      </div>
      <p class="hint" style="margin-top:8px;">Admin user: <code>admin / admin123</code> (demo)</p>
    </div>
  </div>

<script>
// Prediction form logic
// Handles prediction form submission and result rendering
const form = document.getElementById("predictForm");
const resultWrap = document.getElementById("result");
const resultBox = document.getElementById("resultBox");

// Sync sliders and number inputs for volatile acidity and alcohol
const vaRange = document.getElementById("va_range");
const vaInput = document.getElementById("va_input");
vaRange.addEventListener("input", () => vaInput.value = Number(vaRange.value).toFixed(2));
vaInput.addEventListener("input", () => vaRange.value = vaInput.value);

const alcRange = document.getElementById("alc_range");
const alcInput = document.getElementById("alc_input");
alcRange.addEventListener("input", () => alcInput.value = Number(alcRange.value).toFixed(1));
alcInput.addEventListener("input", () => alcRange.value = alcInput.value);

// Helper: returns color classes for prediction result
function clsColor(name) {
  if (name === "high")   return {badge:"high", fill:"fill-high"};
  if (name === "medium") return {badge:"medium", fill:"fill-medium"};
  return {badge:"low", fill:"fill-low"};
}

// Render prediction result in the resultBox
function renderResult(json) {
  const pred = (json.prediction || "").toLowerCase();
  const palette = clsColor(pred);

  let html = `
    <div class="badge ${palette.badge}">
      Prediction: <strong style="text-transform:uppercase">${pred}</strong>
    </div>
  `;

  // If probabilities are available, show them as bars
  if (json.proba && json.classes) {
    const labels = json.classes;
    const probs  = json.proba;

    html += `<div><div style="font-weight:600;margin:6px 0">Probabilities</div>`;
    labels.forEach((lbl, i) => {
      const color = clsColor(lbl).fill;
      const pct = Math.round((probs[i] || 0) * 100);
      html += `
        <div class="bar-row">
          <div class="bar-meta"><span>${lbl}</span><span>${pct}%</span></div>
          <div class="bar"><div class="bar-fill ${color}" style="width:${pct}%"></div></div>
        </div>
      `;
    });
    html += `</div>`;
  }

  // Show input data used for prediction
  html += `
    <details class="details">
      <summary class="summary">Show input</summary>
      <pre>${JSON.stringify(json.input, null, 2)}</pre>
    </details>
  `;

  resultBox.innerHTML = html;
  resultWrap.style.display = "block";
}

// Handle prediction form submit: POSTs data to /predict and renders result
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(form).entries());
  for (const k in data) if (k !== "type") data[k] = Number(data[k]);
  const res = await fetch("/predict", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(data)
  });
  const json = await res.json();
  renderResult(json);
});

// Preset buttons: fill form with example data for white/red wine
document.getElementById("loadWhite").onclick = () => {
  const preset = {"fixed acidity":7.2,"volatile acidity":0.23,"citric acid":0.32,"residual sugar":8.5,"chlorides":0.058,"free sulfur dioxide":47,"total sulfur dioxide":186,"density":0.9956,"pH":3.19,"sulphates":0.40,"alcohol":9.9,"type":"white"};
  for (const k in preset) {
    const el = form.elements[k];
    if (el) el.value = preset[k];
  }
  vaRange.value = preset["volatile acidity"]; vaInput.value = preset["volatile acidity"];
  alcRange.value = preset["alcohol"]; alcInput.value = preset["alcohol"];
};
document.getElementById("loadRed").onclick = () => {
  const preset = {"fixed acidity":7.4,"volatile acidity":0.70,"citric acid":0.00,"residual sugar":1.9,"chlorides":0.076,"free sulfur dioxide":11,"total sulfur dioxide":34,"density":0.9978,"pH":3.51,"sulphates":0.56,"alcohol":9.4,"type":"red"};
  for (const k in preset) {
    const el = form.elements[k];
    if (el) el.value = preset[k];
  }
  vaRange.value = preset["volatile acidity"]; vaInput.value = preset["volatile acidity"];
  alcRange.value = preset["alcohol"]; alcInput.value = preset["alcohol"];
};

// Authentication logic
// Handles login/logout, JWT storage, and admin panel visibility

// Grab references to auth-related DOM elements
const authBar      = document.getElementById("authBar");
const authStatus   = document.getElementById("authStatus");
const btnLogin     = document.getElementById("btnLogin");
const btnLogout    = document.getElementById("btnLogout");
const adminPanel   = document.getElementById("adminPanel");
const adminOutput  = document.getElementById("adminOutput");

// Modal elements for login dialog
const modal        = document.getElementById("loginModal");
const doLogin      = document.getElementById("doLogin");
const cancelLogin  = document.getElementById("cancelLogin");
const loginUser    = document.getElementById("loginUser");
const loginPass    = document.getElementById("loginPass");

// Helper: get JWT token and role from localStorage
function getToken() { try { return localStorage.getItem("jwt_token"); } catch { return null; } }
function getRole()  { try { return localStorage.getItem("jwt_role"); }  catch { return null; } }

// Set authentication state in localStorage and update UI
function setAuth(token, role) {
  if (token) localStorage.setItem("jwt_token", token); else localStorage.removeItem("jwt_token");
  if (role)  localStorage.setItem("jwt_role", role);   else localStorage.removeItem("jwt_role");
  renderAuth();
}

// Update UI based on authentication state (shows/hides admin panel)
function renderAuth() {
  const token = getToken();
  const role  = getRole();
  if (!token) {
    authStatus.textContent = "Not logged in";
    btnLogin.style.display = "";
    btnLogout.style.display = "none";
    adminPanel.style.display = "none";
  } else {
    authStatus.textContent = `Logged in as ${role || "user"}`;
    btnLogin.style.display = "none";
    btnLogout.style.display = "";
    // Only show admin panel if role is admin
    adminPanel.style.display = (role === "admin") ? "" : "none";
  }
}

// Helper: attaches Authorization header if JWT token exists
function authHeaders(extra={}) {
  const token = getToken();
  return token ? { ...extra, Authorization: `Bearer ${token}` } : extra;
}

// Login modal handling
// Show modal when login button is clicked
btnLogin.onclick = () => { modal.style.display = "flex"; loginUser.focus(); };
// Hide modal when cancel is clicked
cancelLogin.onclick = () => { modal.style.display = "none"; };
// Log out: clear auth state and update UI
btnLogout.onclick = () => { setAuth(null, null); adminOutput.textContent = "Logged out."; };

// Handle login: POST credentials to /auth/login, store JWT and role on success
doLogin.onclick = async () => {
  try {
    // IMPORTANT: endpoint must match Flask backend
    const res = await fetch("/auth/login", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ username: loginUser.value.trim(), password: loginPass.value })
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    setAuth(json.token, json.role); // Save token and role for later requests
    modal.style.display = "none";
  } catch (e) {
    alert("Login failed. Check credentials.");
  }
};

// Admin panel button handlers
// Each button sends a request to an admin endpoint, using JWT for authorization

document.getElementById("btnAdminInfo").onclick = async () => {
  try {
    const res = await fetch("/admin/model-info", { headers: authHeaders() });
    const json = await res.json();
    adminOutput.textContent = JSON.stringify(json, null, 2);
  } catch (e) {
    adminOutput.textContent = "Error: " + e;
  }
};

document.getElementById("btnReload").onclick = async () => {
  try {
    const res = await fetch("/admin/reload-model", { method:"POST", headers: authHeaders() });
    const json = await res.json();
    adminOutput.textContent = JSON.stringify(json, null, 2);
  } catch (e) {
    adminOutput.textContent = "Error: " + e;
  }
};

document.getElementById("btnBatch").onclick = async () => {
  try {
    // Example batch prediction request
    const batch = [{
      "fixed acidity": 7.2, "volatile acidity": 0.23, "citric acid": 0.32, "residual sugar": 8.5,
      "chlorides": 0.058, "free sulfur dioxide": 47, "total sulfur dioxide": 186, "density": 0.9956,
      "pH": 3.19, "sulphates": 0.40, "alcohol": 9.9, "type": "white"
    }];
    const res = await fetch("/admin/predict-batch", {
      method:"POST",
      headers: authHeaders({"Content-Type":"application/json"}),
      body: JSON.stringify(batch)
    });
    const json = await res.json();
    adminOutput.textContent = JSON.stringify(json, null, 2);
  } catch (e) {
    adminOutput.textContent = "Error: " + e;
  }
};

document.getElementById("btnFI").onclick = async () => {
  try {
    const res = await fetch("/admin/feature-importance", { headers: authHeaders() });
    const json = await res.json();
    adminOutput.textContent = JSON.stringify(json, null, 2);
  } catch (e) {
    adminOutput.textContent = "Error: " + e;
  }
};

document.getElementById("btnLogs").onclick = async () => {
  try {
    const res = await fetch("/admin/logs", { headers: authHeaders() });
    const json = await res.json();
    adminOutput.textContent = JSON.stringify(json, null, 2);
  } catch (e) {
    adminOutput.textContent = "Error: " + e;
  }
};

document.getElementById("btnClearLogs").onclick = async () => {
  try {
    const res = await fetch("/admin/logs", { method:"DELETE", headers: authHeaders() });
    const json = await res.json();
    adminOutput.textContent = JSON.stringify(json, null, 2);
  } catch (e) {
    adminOutput.textContent = "Error: " + e;
  }
};

// Initial render of authentication state on page load
renderAuth();
</script>
</body>
</html>
